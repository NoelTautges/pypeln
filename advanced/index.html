
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="ie=edge" http-equiv="x-ua-compatible"/>
<link href="https://cgarciae.github.io/pypeln/advanced/" rel="canonical"/>
<meta content="Copy to clipboard" name="lang:clipboard.copy"/>
<meta content="Copied to clipboard" name="lang:clipboard.copied"/>
<meta content="en" name="lang:search.language"/>
<meta content="True" name="lang:search.pipeline.stopwords"/>
<meta content="True" name="lang:search.pipeline.trimmer"/>
<meta content="No matching documents" name="lang:search.result.none"/>
<meta content="1 matching document" name="lang:search.result.one"/>
<meta content="# matching documents" name="lang:search.result.other"/>
<meta content="[\s\-]+" name="lang:search.tokenizer"/>
<link href="../assets/images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-4.6.3" name="generator"/>
<title>Advanced Usage - Pypeln</title>
<link href="../assets/stylesheets/application.adb8469c.css" rel="stylesheet"/>
<script src="../assets/javascripts/modernizr.86422ebf.js"></script>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
<link href="../assets/fonts/material-icons.css" rel="stylesheet"/>
</head>
<body dir="ltr">
<svg class="md-svg">
<defs>
<svg height="448" id="__github" viewbox="0 0 416 448" width="416" xmlns="http://www.w3.org/2000/svg"><path d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z" fill="currentColor"></path></svg>
</defs>
</svg>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<a class="md-skip" href="#advanced-usage" tabindex="0">
        Skip to content
      </a>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a aria-label="Pypeln" class="md-header-nav__button md-logo" href="https://cgarciae.github.io/pypeln" title="Pypeln">
<i class="md-icon"></i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
              Pypeln
            </span>
<span class="md-header-nav__topic">
              
                Advanced Usage
              
            </span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/>
<label class="md-icon md-search__icon" for="__search"></label>
<button class="md-icon md-search__icon" data-md-component="reset" tabindex="-1" type="reset">
        
      </button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
            Type to start searching
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a class="md-source" data-md-source="github" href="https://github.com/cgarciae/pypeln/" title="Go to repository">
<div class="md-source__icon">
<svg height="24" viewbox="0 0 24 24" width="24">
<use height="24" width="24" xlink:href="#__github"></use>
</svg>
</div>
<div class="md-source__repository">
    cgarciae/pypeln
  </div>
</a>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container">
<main class="md-main" role="main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title md-nav__title--site" for="__drawer">
<a class="md-nav__button md-logo" href="https://cgarciae.github.io/pypeln" title="Pypeln">
<i class="md-icon"></i>
</a>
    Pypeln
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-source="github" href="https://github.com/cgarciae/pypeln/" title="Go to repository">
<div class="md-source__icon">
<svg height="24" viewbox="0 0 24 24" width="24">
<use height="24" width="24" xlink:href="#__github"></use>
</svg>
</div>
<div class="md-source__repository">
    cgarciae/pypeln
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href=".." title="Introduction">
      Introduction
    </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-toggle md-nav__toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        Advanced Usage
      </label>
<a class="md-nav__link md-nav__link--active" href="./" title="Advanced Usage">
      Advanced Usage
    </a>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#architecture">
    Architecture
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#stage-types">
    Stage Types
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stages">
    Stages
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#workers">
    Workers
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#queues">
    Queues
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-management">
    Resource Management
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dependency-injection">
    Dependency Injection
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pipe-operator">
    Pipe Operator
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" id="nav-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3">
      API Reference
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-3">
        API Reference
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" id="nav-3-1" type="checkbox"/>
<label class="md-nav__link" for="nav-3-1">
      process
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-3-1">
        process
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/Overview/" title="Overview">
      Overview
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/concat/" title="concat">
      concat
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/each/" title="each">
      each
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/filter/" title="filter">
      filter
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/flat_map/" title="flat_map">
      flat_map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/from_iterable/" title="from_iterable">
      from_iterable
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/map/" title="map">
      map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/ordered/" title="ordered">
      ordered
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/run/" title="run">
      run
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/process/to_iterable/" title="to_iterable">
      to_iterable
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" id="nav-3-2" type="checkbox"/>
<label class="md-nav__link" for="nav-3-2">
      thread
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-3-2">
        thread
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/Overview/" title="Overview">
      Overview
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/concat/" title="concat">
      concat
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/each/" title="each">
      each
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/filter/" title="filter">
      filter
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/flat_map/" title="flat_map">
      flat_map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/from_iterable/" title="from_iterable">
      from_iterable
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/map/" title="map">
      map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/ordered/" title="ordered">
      ordered
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/run/" title="run">
      run
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/thread/to_iterable/" title="to_iterable">
      to_iterable
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" id="nav-3-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3-3">
      task
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-3-3">
        task
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/Overview/" title="Overview">
      Overview
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/concat/" title="concat">
      concat
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/each/" title="each">
      each
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/filter/" title="filter">
      filter
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/flat_map/" title="flat_map">
      flat_map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/from_iterable/" title="from_iterable">
      from_iterable
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/map/" title="map">
      map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/ordered/" title="ordered">
      ordered
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/run/" title="run">
      run
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/task/to_iterable/" title="to_iterable">
      to_iterable
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" id="nav-3-4" type="checkbox"/>
<label class="md-nav__link" for="nav-3-4">
      sync
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-3-4">
        sync
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/Overview/" title="Overview">
      Overview
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/concat/" title="concat">
      concat
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/each/" title="each">
      each
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/filter/" title="filter">
      filter
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/flat_map/" title="flat_map">
      flat_map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/from_iterable/" title="from_iterable">
      from_iterable
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/map/" title="map">
      map
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/ordered/" title="ordered">
      ordered
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/run/" title="run">
      run
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/sync/to_iterable/" title="to_iterable">
      to_iterable
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#architecture">
    Architecture
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#stage-types">
    Stage Types
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stages">
    Stages
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#workers">
    Workers
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#queues">
    Queues
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resource-management">
    Resource Management
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dependency-injection">
    Dependency Injection
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pipe-operator">
    Pipe Operator
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<a class="md-icon md-content__icon" href="https://github.com/cgarciae/pypeln/edit/master/docs/advanced.md" title="Edit this page"></a>
<h1 id="advanced-usage">Advanced Usage</h1>
<h2 id="architecture">Architecture</h2>
<p>A Pypeln pipeline has the following structure:</p>
<p><img alt="diagram" src="https://github.com/cgarciae/pypeln/blob/master/docs/images/diagram.png?raw=true"/></p>
<ul>
<li>Its composed of several concurrent <strong>stages</strong></li>
<li>At each stage it contains on or more <strong>worker</strong> entities that perform a task.</li>
<li>Related stages are connected by a <strong>queue</strong>, workers from one stage <em>put</em> items into it, and workers from the other stage <em>get</em> items from it.</li>
<li>Source stages consume iterables.</li>
<li>Sink stages can be converted into iterables which 
consume them.</li>
</ul>
<h3 id="stage-types">Stage Types</h3>
<p>Pypeln has 3 types of stages, each stage has an associated worker and queue types: </p>
<table>
<thead>
<tr>
<th>Stage Type</th>
<th>Worker</th>
<th>Queue</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pl.process.Stage</code></td>
<td><code>multiprocessing.Process</code></td>
<td><code>multiprocessing.Queue</code></td>
</tr>
<tr>
<td><code>pl.thread.Stage</code></td>
<td><code>threading.Thread</code></td>
<td><code>queue.Queue</code></td>
</tr>
<tr>
<td><code>pl.task.Stage</code></td>
<td><code>asyncio.Task</code></td>
<td><code>asyncio.Queue</code></td>
</tr>
</tbody>
</table>
<p>Depending on the type of stage you use the following characteristics will vary: memory management, concurrency, parallelism, inter-stage communication overhead, worker initialization overhead:</p>
<hr/>
<table>
<thead>
<tr>
<th>Stage Type</th>
<th>Memory</th>
<th>Concurrency</th>
<th>Parallelism</th>
<th>Communication Overhead</th>
<th>Initialization Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>process</code></td>
<td>independent</td>
<td>cpu + IO</td>
<td>cpu + IO</td>
<td>high</td>
<td>high</td>
</tr>
<tr>
<td><code>thread</code></td>
<td>shared</td>
<td>only for IO</td>
<td>only for IO</td>
<td>none</td>
<td>mid</td>
</tr>
<tr>
<td><code>task</code></td>
<td>shared</td>
<td>optimized IO</td>
<td>optimized IO</td>
<td>none</td>
<td>low</td>
</tr>
</tbody>
</table>
<h2 id="stages">Stages</h2>
<p>Stages are lazy <a href="https://docs.python.org/3/glossary.html#term-iterable">iterable</a> objects that only contain meta information about the computation, to actually execute a pipeline you can iterate over it using a for loop, calling <code>list</code>, <code>pl.&lt;module&gt;.run</code>, etc. For example:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pypeln</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>

<span class="k">def</span> <span class="nf">slow_add1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">())</span> <span class="c1"># &lt;= some slow computation</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># [0, 1, 2, ..., 9]</span>
<span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">slow_add1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stage</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># e.g. 2, 1, 5, 6, 3, 4, 7, 8, 9, 10</span>
</code></pre></div>
<p>This example uses <code>pl.process</code> but it works the same for all the other modules. Since <code>pypeln</code> implements the <code>Iterable</code> interface it becomes very intuitive to use and compatible with most other python code. </p>
<h2 id="workers">Workers</h2>
<p>Each Stage defines a number of workers which can usually be controlled by the <code>workers</code> parameter on <code>pypeln</code>'s various functions. In general try not to create more workers than the number of cores you have on your machine or else they will end up fighting for resources, but this varies with the type of worker. The following table shows the relative cost in memory + cpu usage of creating each worker:</p>
<table>
<thead>
<tr>
<th>Worker</th>
<th>Memory + CPU Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Process</code></td>
<td>high</td>
</tr>
<tr>
<td><code>Thread</code></td>
<td>mid</td>
</tr>
<tr>
<td><code>Task</code></td>
<td>low</td>
</tr>
</tbody>
</table>
<p>General guidelines:</p>
<ul>
<li>Only use <code>processes</code> when you need to perform heavy CPU operations in pararallel such as image processing, data transformations, etc. When forking a <code>Process</code> all the memory is copied to the new process, intialization is slow, communications between processes is costly since python objects have to be serialized, but you effectly escape the GIL so you gain true parallelism.</li>
<li><code>Threads</code> are very good for doing syncronous IO tasks such as interacting with the OS and libraries that yet don't expose a <code>async</code> API.</li>
<li><code>Tasks</code> are highly optimized for asynchronous IO operations, they are super cheap to create since they are just regular python objects, and you can generally create them in higher quantities since the event loop manages them efficiently for you. </li>
</ul>
<h2 id="queues">Queues</h2>
<p>Worker communicate between each other through <code>Queues</code>. The maximum number of elements each <code>Queue</code> can hold is controlled by the <code>maxsize</code> parameter in <code>pypeln</code>'s various functions. By default this number is <code>0</code> which means there is no limit to the number of elements, however when <code>maxsize</code> is set it serves as a <a href="https://www.quora.com/What-is-backpressure-in-the-context-of-data-streaming">backpressure</a> mechanism that prevents previous stages from pushing new elements to a Queue when it becomes full (reaches its <code>maxsize</code>), these stages will stop their computation until space becomes available thus potentially preveting <code>OutOfMemeory</code> errors on the slower stages.</p>
<p>The following table shows the relative communication cost between workers given the nature of their queues:</p>
<table>
<thead>
<tr>
<th>Worker</th>
<th>Communication Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Process</code></td>
<td>high</td>
</tr>
<tr>
<td><code>Thread</code></td>
<td>none</td>
</tr>
<tr>
<td><code>Task</code></td>
<td>none</td>
</tr>
</tbody>
</table>
<p>General guidelines:</p>
<ul>
<li>Communication between <code>processes</code> is costly since python objects have to be serialized, which has a considerable overhead when passing large objects such as <code>numpy</code> arrays, binary objects, etc. To avoid this overhead try only passing metadata information such as filepaths between processes.</li>
<li>There is no overhead in communication between <code>threads</code> or <code>tasks</code>, since everything happens in-memory there is no serialization overhead.</li>
</ul>
<h2 id="resource-management">Resource Management</h2>
<p>There are many occasions where you need to create some resource objects (e.g. http or database sessions) that (for efficiency) are expected to last the whole span of each worker's life. To support and effectily manage the lifecycle of such objects most of <code>pypeln</code>s functions accept the <code>on_start</code> and <code>on_done</code> callbacks.</p>
<p>When a worker is created its <code>on_start</code> function get called. This function can return a dictionary containing these resource objects which can be consumed as arguments (by name) on the <code>f</code> and <code>on_end</code> functions. For exmaple:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pypeln</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="k">def</span> <span class="nf">on_start</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">http_session</span> <span class="o">=</span> <span class="n">get_http_session</span><span class="p">(),</span> 
        <span class="n">db_session</span> <span class="o">=</span> <span class="n">get_db_session</span><span class="p">(),</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">http_session</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
    <span class="c1"># some logic</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">on_end</span><span class="p">(</span><span class="n">http_session</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
    <span class="n">http_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">db_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">stage</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">on_start</span><span class="o">=</span><span class="n">on_start</span><span class="p">,</span> <span class="n">on_end</span><span class="o">=</span><span class="n">on_end</span><span class="p">)</span>
</code></pre></div>
<h3 id="dependency-injection">Dependency Injection</h3>
<p><strong>Special Arguments</strong></p>
<ul>
<li><code>worker_info</code>: <code>f</code>, <code>on_start</code> and <code>on_done</code> can define a <code>worker_info</code> argument; an object with information about the worker will be passed.</li>
<li><code>stage_status</code>: <code>on_end</code> can define a <code>stage_status</code> argument; an object with information about the stage will be passed.</li>
<li><code>element_index</code>: <code>f</code> can define a <code>element_index</code> argument; a tuple representing the index of the element will be passed, this index represents the order of creation of the element on the original/source iterable and is the underlying mechanism by which the <code>ordered</code> operation is implemented. Usually it will be a tuple of a single element, but operations like <code>flat_map</code> add an additional index dimension in order to properly keep track of the order. </li>
</ul>
<p><strong>User Defined</strong></p>
<p>Any element in the dictionary returned by <code>on_start</code> can be consumed as an argument by <code>f</code> and <code>on_done</code>.</p>
<h2 id="pipe-operator">Pipe Operator</h2>
<p>Most functions can return a <code>Partial</code> instead of a <code>Stage</code> if the <code>stage</code> argument is not given. These <code>Partial</code>s are callables that accept the missing <code>stage</code> parameter and call the computation. The following expressions are equivalent:</p>
<div class="codehilite"><pre><span></span><code><span class="err">pl.process.map(f, stage, **kwargs) &lt;=&gt; pl.process.map(f, **kwargs)(stage)</span>
</code></pre></div>
<p><code>Partial</code> implements the pipe <code>|</code> operator as</p>
<div class="codehilite"><pre><span></span><code><span class="err">x | partial &lt;=&gt; partial(x)</span>
</code></pre></div>
<p>This allows <code>pypeln</code> to enable you to define your pipelines more fluently:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pypeln</span> <span class="kn">import</span> <span class="n">process</span> <span class="k">as</span> <span class="n">pr</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">slow_add1</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">slow_gt3</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">|</span> <span class="nb">list</span>
<span class="p">)</span>
</code></pre></div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a class="md-flex md-footer-nav__link md-footer-nav__link--prev" href=".." rel="prev" title="Introduction">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                Introduction
              </span>
</div>
</a>
<a class="md-flex md-footer-nav__link md-footer-nav__link--next" href="../api/process/Overview/" rel="next" title="Overview">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                Overview
              </span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" rel="noopener" target="_blank">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs</a>
</div>
<div class="md-footer-social">
<link href="../assets/fonts/font-awesome.css" rel="stylesheet"/>
<a class="md-footer-social__link fa fa-github" href="https://github.com/cgarciae" rel="noopener" target="_blank" title="github"></a>
<a class="md-footer-social__link fa fa-twitter" href="https://twitter.com/cgarciae88" rel="noopener" target="_blank" title="twitter"></a>
<a class="md-footer-social__link fa fa-linkedin" href="https://www.linkedin.com/in/cgarciae" rel="noopener" target="_blank" title="linkedin"></a>
</div>
</div>
</div>
</footer>
</div>
<script src="../assets/javascripts/application.c33a9706.js"></script>
<script>app.initialize({version:"1.1.2",url:{base:".."}})</script>
</body>
</html>